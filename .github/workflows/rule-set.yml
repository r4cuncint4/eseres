name: Update rule-set .srs sing-box

on:
  schedule:
    - cron: '0 11 * * *' # 18:00 WIB = 11:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install sing-box, download & convert domain lists, commit changes
        run: |
          SINGBOX_VERSION="1.12.14"
          RULE_SET_DIR="rule-set"
          mkdir -p $RULE_SET_DIR

          # Install sing-box
          curl -L -o sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz
          mkdir -p sing-box
          tar -xvf sing-box.tar.gz --strip-components=1 -C sing-box
          chmod +x sing-box/sing-box

          # Function to download and convert
          convert() {
            echo "Downloading $1 from $2"
            curl --fail -Ls "$2" -o "$1.txt"
            ./sing-box/sing-box rule-set convert --type adguard --output $RULE_SET_DIR/$1.srs "$1.txt"
          }

          # List domain sources
          convert Core https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/pro.txt
          convert TIF https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/tif.txt
          convert Gambling https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/gambling.txt
          convert BadBlock https://badblock.celenity.dev/wildcards-star/badblock.txt
          convert Whitelist https://badblock.celenity.dev/wildcards-star/whitelist.txt

          # Cleanup
          rm -f *.txt *.tar.gz

          # Commit and push changes if any
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $RULE_SET_DIR/*.srs
          if ! git diff --cached --quiet; then
            git commit -m "Update rule-set files $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push
          else
            echo "No changes detected."
          fi
